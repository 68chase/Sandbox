<div class="row">
	<div class="span3">
		<h3 data-bind="text:currentUser() == false?'Users':currentUser()"></h3>
	</div>
</div>
<div class="row" data-bind="visible:currentUser() == false">
	<div class="span4">
		<a data-bind="click:deleteSelected" href="">Delete Selected</a><br/><br/>
		<a href="{{root}}/admin">Admin Page</a>
	</div>
	<div class="usersList span4">
		<table class="table table-striped" style="border: 1px solid #ddd;">
			<tr>
				<th style="border:none; background:#FFF"></th>
				<th style="border:none; background:#FFF">Name</th>
			</tr>
			<tbody data-bind="foreach:usersList, style:{border:'none'}">
				<td><input type="checkbox" /></td>
				<td><a data-bind="text:$data.Username, attr:{href:'#'+$data.Username}" href=""></a></td>
			</tbody>
		</table>
	</div>
</div>
<div class="row" data-bind="visible:currentUser() != false">
	<div class="span4">
		<a href="#">View full list of users</a>
	</div>
	<div class="usersList span4">
		<form> 
			
			<div style="height:50px;">
				<span>Edit user name:</span>
				<input type="text" style="float:right;" />			
			</div>
			<div>
				<span>Change password:</span>
				<input type="text"style="float:right;" /><br/>
			</div>
	
		</form>
		
		Under construction..
	</div>
</div>
<script>
	vwfPortalModel.usersList = ko.observableArray();
	vwfPortalModel.currentUser = ko.observable(false); 
	
	$.post('{{root}}/data/get_users', function(o){
		o = JSON.parse(o);
		var newObject = [];
		
		for(var i = 0; i < o.length; i++){
			if(o[i]){
				newObject.push(o[i]);
			}
		}

		vwfPortalModel.usersList(newObject);
		handleHash();
	});
	
	vwfPortalModel.deleteSelected = function(data){
		
		var tempUserArr = [], tempArr = [];
		for(var i = 0; i < $('input:checked').length; i++){
			tempUserArr.push(ko.dataFor($('input:checked')[i]));
			tempArr[i] = tempUserArr[i].Username ? tempUserArr[i].Username : tempUserArr[i];
		}
		
		//Make the request to the server to delete these users
		$.post('{{root}}/data/delete_users', JSON.stringify(tempArr), function(o){
			
			for(var i in tempUserArr){
				vwfPortalModel.usersList.remove(tempUserArr[i]);
			}
		});
		console.log("Delete users ", tempUserArr);
		$('input:checked').click();
	}; 
	
	var handleHash = function(){
	
		var tmpHash = window.location.hash.replace("#", "");
		if(tmpHash){
			for(var i in vwfPortalModel.usersList()){
				if(tmpHash == vwfPortalModel.usersList()[i].Username){
					vwfPortalModel.currentUser(tmpHash, vwfPortalModel.usersList()[i].Username);
					console.log(vwfPortalModel.usersList());
					break;
				}
			}
		}
		
		else vwfPortalModel.currentUser(false);
	};
	
	window.onhashchange = handleHash;
	
	$(document).ready(function(){	
	
		handleHash();
		ko.applyBindings(vwfPortalModel);
		getLoginInfo();
	});
</script>