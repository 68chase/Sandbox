<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="{{root}}/css/colorpicker.css" />
    <link rel="stylesheet" media="screen" type="text/css" href="{{root}}/css/bootstrap.min.css" />
    <link rel="stylesheet" media="screen" type="text/css" href="{{root}}/css/bootstrap-responsive.css" />
	<link rel="stylesheet" media="screen" type="text/css" href="{{root}}/css/style.css" />
	<!--[if !IE 7]>
	<style type="text/css">
		#wrapper {display:table;height:100%}
	</style>
	<![endif]-->
    <title>Virtual World Framework</title>
	
	<script type="text/javascript">
		//IE undefined console fix
		if (!window.console) console = {log: function() {}};
	</script>
	<script type="text/javascript" src="{{root}}/jquery-1.7.1.js"></script>
    <script type="text/javascript" src="{{root}}/jquery-ui-1.8.16.custom.js"></script>
    <script type="text/javascript" src="{{root}}/js/knockout-2.2.1.js"></script>
	<script type="text/javascript" src="{{root}}/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="{{root}}/vwf/view/editorview/sha256.js"></script>

    <script type="text/javascript">
		"use strict";
		var filter = ''
		var root = '{{root}}';
		var pageIndex = 0;
		var pageLength = 12;
		var vwfPortalModel = new function(){
			var self = this;
			self.getShorterStr = function(a, length){
				if(a == undefined)
					return '';
				
				var obj = {};
				obj.title = a.title ? a.title : a;
				length = length ? length : 55;
				return (obj.title.length>length)? obj.title.substr(0, length - 3) + '...' : obj.title;
			};
			self.user = ko.observable({
				isLoggedIn: false,
				isAdmin: false,
				username: 'Guest'
			});
			
			self.filterVal = ko.computed({
				read:  function(){ return ''; }, 
				write: function(str){ 
					if(filter != str){
						filter = str;
						pageIndex = 0;
						showStates(); 
					}
				}	
			}).extend({throttle:500});
			
			self.worldObjects = ko.observableArray([]);
			self.displayWorldObjects = ko.observableArray([]);
			self.getNextPage = function(){
				if(self.nextDisabled() === false)
					self.getPage(1);
			};
			self.getPreviousPage = function(){
				if(self.previousDisabled() === false)
					self.getPage(-1);
			};
			
			self.previousDisabled = ko.observable(true);
			self.nextDisabled = ko.observable(true);
			
			self.getPage = function(i){
				var worldObjectsLength = getArrVisibleLength(self.worldObjects());
				pageIndex += i;
				self.displayWorldObjects(getArrVisible(self.worldObjects(), pageIndex*pageLength));
			
				if((pageIndex+1)*pageLength < worldObjectsLength){
					self.nextDisabled(false);
				}
				
				else self.nextDisabled(true);
				
				if(pageIndex > 0){
					self.previousDisabled(false);
				}
				else self.previousDisabled(true);
				
			};

		};
		
		function checkFilter(textArr)
		{
			if(filter != ""){
				for(var i = 0; i < textArr.length; i++){
					if(textArr[i] && textArr[i].toLowerCase().indexOf(filter.toLowerCase()) != -1)
						return true;
				}
				return false;
			}			
			
			else return true;
		}
		
		function getFlatIdArr(resetHotstate){
			var tempArr = [];
			
			//Get all world IDs in flat array form
			for(var i = 0; i < vwfPortalModel.worldObjects().length; i++){
				if(resetHotstate){vwfPortalModel.worldObjects()[i].hotState(false);}
				tempArr.push(vwfPortalModel.worldObjects()[i].id);
			}
			
			return tempArr;
		}
		
		function getArrVisibleLength(arr){
			var count = 0;
			for(var i = 0; i < arr.length; i++){
				if(arr[i].isVisible == true)
					count++;
			}
			
			return count;
		};		
		function getArrVisible(arr, start){
			var tempArr = [];
			var count = 0;
			for(var i = start; i < arr.length && count < pageLength; i++){
			
				if(arr[i].isVisible == true){
					tempArr.push(arr[i]);
					count++;
				}
			}
			
			return tempArr;
		};
		
		function showStates(){
		
			$.getJSON("./vwfDataManager.svc/states",function(e){
				
				var keys = Object.keys(e);
				var tempArr = getFlatIdArr();
				var saveIndex = 0;

				for(var i = 0; i < keys.length; i++){
					
					var id = keys[i].substr(13,16);
					e[keys[i]].id = id;
					e[keys[i]].isVisible = checkFilter([e[keys[i]].title, e[keys[i]].description, e[keys[i]].owner]);
					
					//The incoming data elements may not be in the same order as existing elements, get proper index
					saveIndex = tempArr.indexOf(id);
					saveIndex = saveIndex > -1 ? saveIndex : i;
					
					//If the incoming and currently displayed objects are not the same, then something must have chaged. Update
					if(JSON.stringify(vwfPortalModel.worldObjects()[saveIndex]) != JSON.stringify(e[keys[i]])){
						
						e[keys[i]].hotState = ko.observable(false);
						e[keys[i]].lastUpdate = e[keys[i]].lastUpdate?e[keys[i]].lastUpdate:(new Date()).toString();
						e[keys[i]].description = e[keys[i]].description ? e[keys[i]].description : "No description";
						vwfPortalModel.worldObjects()[saveIndex] = e[keys[i]];	
					}
				}
				
				vwfPortalModel.getPage(0);
				vwfPortalModel.worldObjects.valueHasMutated();
				setTimeout(function(){$(".accordion").css("visibility","visible")}, 300);
				
				
				$.getJSON("./admin/instances",function(e){
				
					//Get all world IDs in flat array form
					var tempArr = getFlatIdArr(true);
					var keys = Object.keys(e);
					var saveIndex = 0;
					
					//Iterate through keys, get index of world id which matches key, set its hotState to true
					for(var i = 0; i < keys.length; i++){
					
						var id = keys[i].substr(13,16);
						saveIndex = tempArr.indexOf(id);
						
						if(saveIndex > -1){
							vwfPortalModel.worldObjects()[saveIndex].hotState(true);
						}	
					}
				});
			});
		}
		
		function getLoginInfo(defaultCb, failCb){
			
			$.ajax('/vwfDataManager.svc/logindata',
			{
				cache:false,
				success:function(data,status,xhr){
					
					data = JSON.parse(xhr.responseText);
					vwfPortalModel.user().username = data.username;
					vwfPortalModel.user().isAdmin = data.admin;
					vwfPortalModel.user().isLoggedIn = (data.username)?true:false;
					vwfPortalModel.user.valueHasMutated();
					
					if(defaultCb) defaultCb();
				},
				error:function(){
					if(failCb) failCb();
					else if(defaultCb) defaultCb();
				}
			});
		}
	</script>
</head>
<body>
	<div id="wrapper">
		<div id="header" style="text-align: center">
			<div class="headerMenu">
				
				
				<div id="username" data-bind="visible:user().isLoggedIn">
					<span class="headerSpan" data-bind="text:'Logged in as: '"></span>
					<a class="headerA" href="{{root}}/user" id="userOptions" data-bind="text: user().username"></a>
				</div>
				<div id="login">
					<a class="headerA" href="{{root}}/login?return=index"  id="login"  data-bind="visible:!user().isLoggedIn">Login</a>
					<a class="headerA" href="{{root}}/logout?return=index" id="logout" data-bind="visible:user().isLoggedIn">Logout</a>
					<a class="headerA" href="{{root}}/signup?return=index" id="signup" data-bind="visible:!user().isLoggedIn">Create Account</a>
				</div>
			</div>
		</div>		
		<div id="content" class="container">
			<div id="pageLogo">
				<h1 style="text-align:center;">Virtual World Framework</h1>
				<h2 style="text-align:center;">Sandbox</h2>
			</div>
			<div class="linkMenu">
				<a href="/">Home</a>
				<a href="">About</a> 
				<a href="http://www.youtube.com/watch?list=PLbhwHX3OvksljQcxLkRT3YvyjgQaIY8m2&v=aWRQJJnBi5c">Videos</a> 
				<a href="{{root}}/help">Help</a> 
			</div>
			<h3>{{title}}</h3>
			{{{yield}}}
			

		</div>
		<div id="footer" class="container">
			<br/><p style="color:#eee">This is the footer.</p>
		</div>
	</div>
</body>
</html>