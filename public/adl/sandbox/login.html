<script type="text/javascript">
	var EncryptPassword = function (password, username,salt)
	{
		var unencrpytedpassword = password + username + salt;
		for (var i = 0; i < 1000; i++)
		{
			unencrpytedpassword = CryptoJS.SHA256(unencrpytedpassword) + '';
		}
		return unencrpytedpassword;
	}
	$(document).ready(function()
	{
		$.ajax('/vwfDataManager.svc/logindata',
			{
				cache:false,
				success:function(data,status,xhr)
				{
					//already logged in, need to redirect back to target!
					redirect();
				},
				error:function(xhr,status,err)
				{
					setup();
				}
			});
	});	
	function redirect()
	{
		var ret = window.location.search.substr(window.location.search.indexOf('=')+1);
		var path = window.location.pathname.substr(0,window.location.pathname.lastIndexOf('/')+1);
		
		var url = window.location.protocol + "//" + window.location.host + path + ret;
		window.location = url;
	}
	function setup()
	{
	
		$('#btnlogin').click(
		function(){
		
			var username = $('#txtusername').val();
			var password = $('#txtpassword').val();
			
			var salt = $.ajax('vwfDataManager.svc/salt?UID='+ username,{async:false}).responseText;
			
			password = EncryptPassword(password,username,$.trim(salt));
			
			$.ajax('/vwfDataManager.svc/sitelogin?UID=' + username +"&P=" + password,
			{
				cache:false,
				success:function(data,status,xhr)
				{
					$('#txtusername').val('');
					$('#txtpassword').val('');
					redirect();
				},
				error:function(xhr,status,err)
				{
					$('#txtusername').val('');
					$('#txtpassword').val('');
					$('#error').text("Error: " + xhr.responseText);
				}
			});
		});
	
	};

</script>
    <div class="wrapper">
		<h1> Virtual World Framework Sandbox Login </h1>
		<div>Enter your name and password below. </div>
		
		<div>
		 <input type='text' id='txtusername' class='input' placeholder='Username'/>
		 <input type='password' id='txtpassword' class='input' placeholder='Password'/>
		 <div id = 'btnlogin' class='button'> Login </div>
		</div>
		<div id='error' style="margin-top: 20PX;font-size: 3EM;color: red;"/>
		
    </div>