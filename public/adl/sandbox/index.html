<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<link rel="stylesheet" href="css/colorpicker.css" type="text/css" />
    <link rel="stylesheet" media="screen" type="text/css" href="css/layout.css" />
    <link rel="stylesheet" media="screen" type="text/css" href="style.css" />
    <title>Virtual World Framework</title>
	<script type="text/javascript" src="jquery-1.7.1.js"></script>
    <script type="text/javascript" src="jquery-ui-1.8.16.custom.js"></script>
    <script type="text/javascript" src="knockout-2.2.1.js"></script>


    <script type="text/javascript">
		var vwfPortalModel = {
		
			user: ko.observable({
				isLoggedIn: false,
				isAdmin: false,
				username: 'Guest'
			}),
			
			worldObjects: ko.observableArray()	
		};
		
		function checkFilter(text)
		{
			var filter = $('#filter').val();
			if(text.toLowerCase().indexOf(filter.toLowerCase()) != -1)
				return true;
			return false;	
		
		}
		
		function getFlatIdArr(){
			var tempArr = [];
			
			//Get all world IDs in flat array form
			for(var i = 0; i < vwfPortalModel.worldObjects().length; i++){
				tempArr.push(vwfPortalModel.worldObjects()[i].id);
			}
			
			return tempArr;
		}
		function showStates()
		{

			$.getJSON("./vwfDataManager.svc/states",function(e)
			{
				var keys = Object.keys(e);
				var tempArr = getFlatIdArr();
				var saveIndex = 0;

				for(var i = 0; i < keys.length; i++)
				{
					var id = keys[i].substr(13,16);
					e[keys[i]].id = id;
					
					saveIndex = tempArr.indexOf(id);
					saveIndex = saveIndex > -1 ? saveIndex : i;

					e[keys[i]].hotState = ko.observable();
					
					//If the incoming and currently displayed objects are not the same, update
					if(JSON.stringify(vwfPortalModel.worldObjects()[saveIndex]) != JSON.stringify(e[keys[i]]))
						vwfPortalModel.worldObjects()[saveIndex] = e[keys[i]];
				}
				
				vwfPortalModel.worldObjects.valueHasMutated();
				
				$.getJSON("./admin/instances",function(e)
				{
					//Get all world IDs in flat array form
					var tempArr = getFlatIdArr();
					var keys = Object.keys(e);
					var saveIndex = 0;

					//Iterate through keys, get index of world id which matches key, set its hotState to true
					for(var i = 0; i < keys.length; i++)
					{
						var id = keys[i].substr(13,16);
						saveIndex = tempArr.indexOf(id);
						
						if(saveIndex > -1){
							vwfPortalModel.worldObjects()[saveIndex].hotState(true);
						}	
					}
				});
			
			});
		}
		

		$(document).ready(function()
		{	
			ko.applyBindings(vwfPortalModel);
			$.ajax('/vwfDataManager.svc/logindata',
			{
				cache:false,
				success:function(data,status,xhr)
				{
					data = JSON.parse(xhr.responseText);
					vwfPortalModel.user().username = data.username;
					vwfPortalModel.user().isAdmin = data.admin;
					vwfPortalModel.user().isLoggedIn = true;
						
					showStates();
					$('#filter').keyup(function()
					{
						showStates();
					});
					window.setInterval(function(){
						showStates();
					},5000);
					
					vwfPortalModel.user.valueHasMutated();
				},
				error:function(xhr,status,err)
				{

					showStates();
					$('#filter').keyup(function()
					{
						showStates();
					});
					window.setInterval(function(){
						showStates();
					},5000);
				}
					
			});
			
		});
	
	</script>
</head>
<body>
	<div id="wrapper">
		<div id="header" style="text-align: center">
			<div>
				<span id="username" data-bind="text:'Logged in as: ' + user().username, visible:user().isLoggedIn"></span>
				<a href="login.html?return=index.html"  id="login"  data-bind="visible:!user().isLoggedIn">Login</a>
				<a href="logout.html?return=index.html" id="logout" data-bind="visible:user().isLoggedIn">Logout</a>
				<a href="signup.html?return=index.html" id="signup" data-bind="visible:!user().isLoggedIn">Create Account</a>
			</div>
		</div>	
		<div id="content">
			<h1> Virtual World Framework Sandbox</h1>
			<div>
				Welcome to the Virtual World Framework Sandbox application. This landing page lists the worlds that currently exist. Worlds in green are currently active, while worlds in white are in
				"cold storage". Active worlds are worlds that currently have at least one client viewing them. You can click on any of the world names to launch that world. Or, you can choose "Make a
				new world" 
			</div>
			
			<div>
				<input id="filter" type="text" placeholder="Filter Results" style="margin: 10px;"/>
			</div>
			
			<div style="float:left;" data-bind="visible:user().isLoggedIn">
				<a href="createInstance.html" class="coldstate" id="newinstancebutton"><img style="height: 204px;" src="icons/add.png"></a>
			</div>
			<div id="activeInstances" style='width:800px' data-bind="foreach:worldObjects">
			
				<div data-bind="css:hotState()?'hotstate':'coldstate'">
					<div class="editstate">
						<a class="editstatedata" data-bind="attr:{href:'editInstance.html?id='+id}"><img src="icons/edit.jpg"></a>
						<a class="editstatedelete" data-bind="attr:{href:'deleteInstance.html?id='+id}"><img src="icons/delete.png"></a>
					</div>
					
					<a data-bind="attr:{href:id}">
						<div class="title" data-bind="text:title"></div>
						<div class="description" data-bind="text:description"></div>
						<div class="owner" data-bind="text:owner"></div>
						<div class="objects" data-bind="text:objects"></div>
						<div class="lastModified" data-bind="text:lastUpdate"></div>
						<div class="stateid" data-bind="text:id"></div>
					</a>
				</div>

			</div>
			<div id="coldInstances" style='width:800px'></div>
		</div>
	</div>
</body>
</html>
