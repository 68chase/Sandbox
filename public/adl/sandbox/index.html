<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<link rel="stylesheet" href="css/colorpicker.css" type="text/css" />
    <link rel="stylesheet" media="screen" type="text/css" href="css/layout.css" />
    <link rel="stylesheet" media="screen" type="text/css" href="style.css" />
    <title>Virtual World Framework</title>
	<script type="text/javascript" src="jquery-1.7.1.js"></script>
    <script type="text/javascript" src="jquery-ui-1.8.16.custom.js"></script>
    <script type="text/javascript" src="knockout-2.2.1.js"></script>


    <script type="text/javascript">
		var g_Username;
		var g_Admin = false;
		function checkFilter(text)
		{
			var filter = $('#filter').val();
			if(text.toLowerCase().indexOf(filter.toLowerCase()) != -1)
				return true;
			return false;	
		
		}
		function showStates()
		{
			
			$.getJSON("./vwfDataManager.svc/states",function(e)
			{

				$('#activeInstances').empty();
				if(g_Username)
				{
					
					$('#activeInstances').append('<a href="createInstance.html" class="coldstate" id="newinstancebutton" ><img style="height: 204px;" src="icons/add.png"></a>');
				}
				
				var keys = Object.keys(e);
				for(var i = 0; i < keys.length; i++)
				{
					var id = keys[i].substr(13,16);
					var show = checkFilter(e[keys[i]].title) ||
							   checkFilter(e[keys[i]].description) ||
							   checkFilter(e[keys[i]].owner);
					
					if($('#'+id).length == 0 && show)
					{
						
						$('#activeInstances').append('<div class="coldstate" id="'+id+'" ></div>');
						//$('#'+id).click(function(){
						//	var str = window.location.pathname;
						//	str = str.substr(0,str.lastIndexOf('/')+1)
						//	window.location.pathname = str + $(this).attr('id') + '/';
						//});
						
						$('#'+id).append('<div id="'+id+"edit"+'"class="editstate"></div>');
						
						$('#'+id+"edit").append('<a id="'+id+"editData"+'"class="editstatedata"><img src="icons/edit.jpg"></a>');
						$('#'+id+"edit").append('<a id="'+id+"editDelete"+'"class="editstatedelete"><img src="icons/delete.png"></a>');
						
						
						
						$('#'+id).append('<a  id="'+id+'data" ></a>');
						$('#'+id+'data').attr('href',id);
						$('#'+id+'editDelete').attr('href','deleteInstance.html?id='+id);
						$('#'+id+'editData').attr('href','editInstance.html?id='+id);
						
						$('#'+id+'data').append('<div class="title">'+e[keys[i]].title+'</div>');
						$('#'+id+'data').append('<div class="description">'+e[keys[i]].description+'</div>');
						$('#'+id+'data').append('<div class="owner">Owner: '+e[keys[i]].owner+'</div>');
						$('#'+id+'data').append('<div class="objects">Objects: '+e[keys[i]].objects+'</div>');
						$('#'+id+'data').append('<div class="lastModified">Last Modified: '+e[keys[i]].lastUpdate+'</div>');
						$('#'+id+'data').append('<div class="stateid">'+keys[i]+'</div>');
						
						if(g_Username != e[keys[i]].owner && !g_Admin)
						{
							$('#'+id+"edit").hide();
						}
					}
				}
				
				$.getJSON("./admin/instances",function(e)
				{
					var keys = Object.keys(e);
					for(var i = 0; i < keys.length; i++)
					{
						var id = keys[i].substr(13,16);
						$('#'+id).attr("class", "hotstate");
					}
				});
			
			});
		}
		$(document).ready(function()
		{
			
			$.ajax('/vwfDataManager.svc/logindata',
				{
					cache:false,
					success:function(data,status,xhr)
					{
						data = JSON.parse(xhr.responseText);
						$('#username').text("Logged in as: " + data.username);
						g_Username = data.username;
						g_Admin = data.admin;
						$('#login').hide();
						$('#signup').hide();
						
						if(!g_Admin)
             				$('#admin').hide();
						showStates();
						$('#filter').keyup(function()
						{
							showStates();
						});
						window.setInterval(function(){
							showStates();
						},5000);
					},
					error:function(xhr,status,err)
					{
						$('#username').hide();
						$('#logout').hide();
						$('#newstatearea').hide();
						$('#admin').hide();
						$('#account').hide();
						showStates();
						$('#filter').keyup(function()
						{
							showStates();
						});
						window.setInterval(function(){
							showStates();
						},5000);
					}
					
			});
			
		});
	
	</script>
</head>
<body>
	<div id="wrapper">
		<div id="header" style="text-align: center">
			<div>
				<span href="" id="username">Name</span>
				<a href="login.html?return=index.html" id="login">Login</a>
				<a href="logout.html?return=index.html" id="logout">Logout</a>
				<a href="signup.html?return=index.html" id="signup">Create Account</a>
			</div>
		</div>	
		<div id="content">
			<h1> Virtual World Framework Sandbox </h1>
			<div>Welcome to the Virtual World Framework Sandbox application. This landing page lists the worlds that currently exist. Worlds in green are currently active, while worlds in white are in "cold storage". Active worlds are worlds that currently have at least one client viewing them. You can click on any of the world names to launch that world. Or, you can choose "Make a new world" </div>
			
			
			<div>
				<input id="filter" type="text" placeholder="Filter Results" style="margin: 10px;"/>
			</div>
			<div id="activeInstances" style='width:800px'>
			
			</div>
			<div id="coldInstances" style='width:800px'>
			
			</div>
		</div>
	</div>
</body>
</html>
